name: Create Release

on:
  workflow_dispatch:
    inputs:
      version:
        description: "Release version (e.g., v1.0.0 or v1.0.0-beta)"
        required: true
        type: string

jobs:
  create-release:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4.2.2

      - name: Validate version format
        run: |
          if [[ ! "${{ github.event.inputs.version }}" =~ ^v[0-9]+\.[0-9]+\.[0-9]+(-beta)?$ ]]; then
            echo "Error: Version must be in format v1.0.0 or v1.0.0-beta"
            exit 1
          fi

      - name: Create zip archive
        run: |
          cd src
          zip -r ../Bills-MoP-Profiles-${{ github.event.inputs.version }}.zip */ -x "*/.*"
          cd ..
          echo "ZIP_FILE=Bills-MoP-Profiles-${{ github.event.inputs.version }}.zip" >> $GITHUB_ENV

      - name: Generate release notes
        run: |
          cat << EOF > release_notes.md
          # Bill's MoP Profiles ${{ github.event.inputs.version }}

          Automated Baneto profiles for Mists of Pandaria dailies. Download, extract, and load the start files to begin.

          ## ‚úÖ What's Included
          - **Golden Lotus Dailies**
            - Temple of the White Tiger and Mistfall Village hubs with rotating objectives
            - Smart routing and skip logic for unavailable or completed quests
          - **Klaxxi Dailies**
            - 12 rotating daily quests from multiple NPCs
            - Automatic acceptance, chaining, and turn-ins

          ## üì• Installation
          1. Download the asset: `Bills-MoP-Profiles-${{ github.event.inputs.version }}.zip`
          2. Extract the ZIP into your Baneto profiles directory
          3. In Baneto Local Profiles, load:
             - **Golden Lotus**: `Golden Lotus Dailies/Golden_Lotus_00_Start_Here_Accept_All.lua`
             - **Klaxxi**: `Klaxxi Dailies/Klaxxi_00_Start_Here_Klaxxi_Accept_All.lua`

          ## üß© Requirements
          - World of Warcraft: Mists of Pandaria
          - Baneto Bot framework
          - Level 90 character
          - Faction reputation: Friendly+ recommended

          ## ‚ÑπÔ∏è Notes
          - Tested primarily on Horde
          - If you get stuck, restart from the listed start files

          ## üîó Links
          - [GitHub Repository](https://github.com/BillChirico/Bills-MoP-Profiles)
          - [Report Issues](https://github.com/BillChirico/Bills-MoP-Profiles/issues)
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@v2.3.2
        with:
          tag_name: ${{ github.event.inputs.version }}
          name: Bill's MoP Profiles ${{ github.event.inputs.version }}
          body_path: release_notes.md
          draft: false
          prerelease: ${{ contains(github.event.inputs.version, 'beta') }}
          files: |
            ${{ env.ZIP_FILE }}
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Upload artifact
        uses: actions/upload-artifact@v4.6.2
        with:
          name: Bills-MoP-Profiles-${{ github.event.inputs.version }}
          path: ${{ env.ZIP_FILE }}
